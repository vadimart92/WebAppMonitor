CREATE DATABASE tmp;
 GO;  
USE tmp
GO

CREATE TABLE Dates (Id INT PRIMARY KEY CLUSTERED IDENTITY, Date DATE)
GO

CREATE TABLE dbo.QueryHistory (
	Id UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID() PRIMARY KEY CLUSTERED
   ,username NVARCHAR(MAX) NULL
   ,session_id NVARCHAR(MAX) NULL
   ,client_hostname NVARCHAR(MAX) NULL
   ,duration_sec  DECIMAL(18, 2)  NULL
   ,cpu_time_sec  DECIMAL(18, 2)  NULL
   ,logical_reads BIGINT NULL
   ,writes BIGINT NULL
   ,row_count BIGINT NULL
   ,end_time_utc DATETIME NULL
	, DateId INT FOREIGN KEY REFERENCES Dates (Id)
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
	
CREATE INDEX IDX_QueryHistory_DateId
ON QueryHistory (DateId)
ON [PRIMARY]

CREATE TABLE dbo.NormQueryTextHistory (
	Id UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID() PRIMARY KEY CLUSTERED
   ,NormalizedQuery VARCHAR(MAX)
   ,QueryHash VARBINARY(64)
)

CREATE INDEX IDX_NormQueryTextHistory_QueryHash
ON NormQueryTextHistory (QueryHash)
ON [PRIMARY]
GO
CREATE TABLE dbo.QueryTextHistory (
	QueryHistoryId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES QueryHistory
   ,NormQueryTextHistoryId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES NormQueryTextHistory
)
GO
CREATE TABLE dbo.TodayQuery (
	Id UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID() PRIMARY KEY CLUSTERED
   ,username NVARCHAR(MAX) NULL
   ,session_id NVARCHAR(MAX) NULL
   ,client_hostname NVARCHAR(MAX) NULL
   ,duration_sec  DECIMAL(18, 2)  NULL
   ,cpu_time_sec  DECIMAL(18, 2)  NULL
   ,logical_reads BIGINT NULL
   ,writes BIGINT NULL
   ,row_count BIGINT NULL
   ,end_time_utc DATETIME NULL
)
GO	
CREATE TABLE dbo.TodayNormQueryText (
	Id UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID() PRIMARY KEY CLUSTERED
   ,NormalizedQuery VARCHAR(MAX)
   ,QueryHash VARBINARY(64)
)
GO
CREATE TABLE dbo.TodayQueryText (
	TodayQueryId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES TodayQuery
	,QueryText VARCHAR(MAX)
	, TodayNormQueryTextId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES TodayQuery
)
GO
CREATE TABLE dbo.TempNormQueryText (
	TodayQueryId UNIQUEIDENTIFIER NULL
   ,NormalizedQuery NVARCHAR(MAX) NULL
   ,NormalizedQueryHash VARBINARY(64) NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
CREATE TABLE dbo.ts_sqlprofiler (
	Id UNIQUEIDENTIFIER NULL
   ,db_name NVARCHAR(MAX) NULL
   ,username NVARCHAR(MAX) NULL
   ,session_id NVARCHAR(MAX) NULL
   ,client_hostname NVARCHAR(MAX) NULL
   ,duration_sec  DECIMAL(18, 2)  NULL
   ,cpu_time_sec  DECIMAL(18, 2)  NULL
   ,logical_reads BIGINT NULL
   ,writes BIGINT NULL
   ,row_count BIGINT NULL
   ,end_time_utc DATETIME NULL
   ,statement VARCHAR(MAX) NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

CREATE TABLE dbo.ts_sqlprofiler_data (
	XML XML NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

CREATE INDEX ixHash ON TempNormQueryText (NormalizedQueryHash);
IF OBJECT_ID('SaveDailyData', 'P') IS NULL BEGIN
	DECLARE @SQL NVARCHAR(MAX) ='CREATE PROCEDURE SaveDailyData AS BEGIN SET NOCOUNT ON END'
    EXEC sys.sp_executesql @SQL
END
ALTER PROCEDURE SaveDailyData AS BEGIN

	WITH ImportDates AS (
		SELECT DISTINCT CAST(tq.end_time_utc AS DATE) ImportDate
		FROM TodayQuery tq
	)
	INSERT INTO Dates(Date)
		SELECT d.ImportDate
		FROM ImportDates d
			WHERE d.ImportDate NOT IN (SELECT Date FROM Dates)
	

	INSERT INTO QueryHistory (Id, username, session_id, client_hostname, duration_sec, cpu_time_sec, logical_reads, writes, row_count, end_time_utc, DateId)
	SELECT Id
		  ,username
		  ,session_id
		  ,client_hostname
		  ,duration_sec
		  ,cpu_time_sec
		  ,logical_reads
		  ,writes
		  ,row_count
		  ,end_time_utc
		 ,	(SELECT Id FROM Dates d WHERE d.Date = CAST(end_time_utc AS DATE))
	FROM TodayQuery;

	INSERT INTO NormQueryTextHistory (NormalizedQuery, QueryHash)
	SELECT tnqt.NormalizedQuery
		  ,tnqt.QueryHash
	FROM TodayNormQueryText tnqt
	WHERE tnqt.QueryHash NOT IN (SELECT QueryHash FROM NormQueryTextHistory)


	INSERT INTO QueryTextHistory (QueryHistoryId, NormQueryTextHistoryId)
	SELECT tqt.TodayQueryId
			,nqth.Id
	FROM TodayQueryText tqt
		INNER JOIN TodayNormQueryText tnqt ON tqt.TodayNormQueryTextId = tnqt.Id
		INNER JOIN NormQueryTextHistory nqth ON tnqt.QueryHash = nqth.QueryHash

END

ALTER ASSEMBLY [ExtendedEventsUtils]
DROP FILE ALL;


GO
ALTER ASSEMBLY [ExtendedEventsUtils]
FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300BFBC54590000000000000000E00022200B013000000800000006000000000000DA270000002000000040000000000010002000000002000004000000000000000600000000000000008000000002000000000000030060850000100000100000000010000010000000000000100000000000000000000000882700004F00000000400000D002000000000000000000000000000000000000006000000C000000502600001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000E0070000002000000008000000020000000000000000000000000000200000602E72737263000000D00200000040000000040000000A0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000000E00000000000000000000000000004000004200000000000000000000000000000000BC2700000000000048000000020005001C210000340500000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000133001001700000001000011000F00280500000A2802000006730600000A0A2B00062A00133004007B000000020000110002280700000A130511052C06000213062B65026F0800000A10000272010000701A6F0900000A17580A027201000070061A6F0A00000A0B0706590C061531110816310D026F0B00000A065908FE022B01160D092D03022B080206086F0C00000A13047E01000004110472050000706F0D00000A13062B0011062A2202280E00000A002A567209000070200A020000730F00000A80010000042A000042534A4201000100000000000C00000076342E302E33303331390000000005006C000000C0010000237E00002C0200001002000023537472696E6773000000003C04000040000000235553007C0400001000000023475549440000008C040000A800000023426C6F620000000000000002000001571502000900000000FA013300160000010000000B000000020000000100000004000000020000000F000000040000000200000001000000030000000000DC00010000000000060063004C01060083004C0106003A0039010F006C0100000600E501F4000A000902A4010E004E0011010E00BD007B010600C000F40006000001F4000A00D801A401000000000100000000000100010001001000C3010000150001000100310005025C005020000000009600F201600001007420000000009100AB0067000200FB200000000086182C0106000300042100000000911832016C00030000000100EC0100000100EC0109002C01010011002C01060019002C010A0039002C0106004100A100150041002C0119004900270028004900FB0015004900B5002D004900B50034004900D1003C004900C700400031001F00460029002C01060031002C014C0020002300A1002E000B0070002E00130079002E001B00980010001E000480000000000000000000000000000000009001000004000000000000000000000053001600000000000400000000000000000000005300F4000000000004000000000000000000000053000A00000000000000003C4D6F64756C653E0053797374656D2E44617461006D73636F726C6962005265706C6163650049734E756C6C4F72576869746553706163650044656275676761626C654174747269627574650053716C46756E6374696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465006765745F56616C7565004E6F726D616C697A6500496E6465784F660053716C537472696E6700537562737472696E67006765745F4C656E67746800457874656E6465644576656E74735574696C732E646C6C0053797374656D005472696D00537472696E67436F6D70617269736F6E004D6963726F736F66742E53716C5365727665722E536572766572002E63746F72002E6363746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053797374656D2E446174612E53716C547970657300457874656E6465644576656E74735574696C730053797374656D2E546578742E526567756C617245787072657373696F6E730055736572446566696E656446756E6374696F6E730052656765784F7074696F6E73004F626A65637400696E707574004E6F726D616C697A65517565727954657874005F656F6C52656765780000000327000103200000355C0072005C0073002A007C005C006E005C0073002A007C005C0072005C006E0073002A007C005C006E005C0072005C0073002A00000003ED2EEAB55A81488C3A78084E460F1E0004200101080320000105200101111104070111210320000E042001010E090707080808020E020E040001020E062002080E1129072003080E081129032000080520020E08080520020E0E0E062002010E112D08B77A5C561934E08903061219060001112111210400010E0E030000010801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000701000000000401000000000000000000BFBC545900000000020000001C0100006C2600006C0800005253445366C902C5486C3A42BEF7A41729EBAF7D01000000433A5C50726F6A656374735C4769745C5765624170704D6F6E69746F725C457874656E6465644576656E74735574696C735C6F626A5C44656275675C457874656E6465644576656E74735574696C732E706462000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B02700000000000000000000CA270000002000000000000000000000000000000000000000000000BC270000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF2500200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000740200000000000000000000740234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004D4010000010053007400720069006E006700460069006C00650049006E0066006F000000B001000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E003000000050001800010049006E007400650072006E0061006C004E0061006D006500000045007800740065006E006400650064004500760065006E00740073005500740069006C0073002E0064006C006C0000002800020001004C006500670061006C0043006F0070007900720069006700680074000000200000005800180001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000045007800740065006E006400650064004500760065006E00740073005500740069006C0073002E0064006C006C000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E00300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000DC3700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000;


GO
ALTER ASSEMBLY [ExtendedEventsUtils]
DROP FILE ALL
ADD FILE FROM 0x4D6963726F736F667420432F432B2B204D534620372E30300D0A1A4453000000000200000200000017000000780000000000000015000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C0FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF3800C0FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0BCA3101380000000010000000100000000000000E00FFFF04000000FFFF03000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000BCA3101380000000010000000100000000000000F00FFFF04000000FFFF0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000942E3101BFBC54590100000066C902C5486C3A42BEF7A41729EBAF7D00000000000000000100000001000000000000000000000000000000DC51330100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000BCA310138000000001000000010000000000000FFFFFFFF04000000FFFF030000000000FFFFFFFF00000000FFFFFFFF00000000FFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000BCA310138000000001000000010000000000000FFFFFFFF04000000FFFF030000000000FFFFFFFF00000000FFFFFFFF00000000FFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F862513FC607D311905300C04FA302A1C4454B99E9E6D211903F00C04FA302A10B9D865A1166D311BD2A0000F80849BDEC1618FF5EAA104D87F76F4963833460140000000000000017C5BE0858E69153A8309A4A409C8A59669D1D290000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000A700000000000000A7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FEEFFEEF010000009200000000433A5C50726F6A656374735C4769745C5765624170704D6F6E69746F725C457874656E6465644576656E74735574696C735C4E6F726D616C697A655175657279546578742E63730000633A5C70726F6A656374735C6769745C7765626170706D6F6E69746F725C657874656E6465646576656E74737574696C735C6E6F726D616C697A657175657279746578742E637300040000004900000000000000010000004A000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001BE23001800000005669CB37B3F0D20101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000020000000100000001000000000000004A000000280000001BE230018078AF865C00000001000000490000004A000000650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000003A002A1100000000E400000000000000170000000000000000000000010000060000000001000000004E6F726D616C697A65517565727954657874001600031104000000A40000001700000000000000010000000A0024115553797374656D001A0024115553797374656D2E446174612E53716C5479706573000000220024115553797374656D2E546578742E526567756C617245787072657373696F6E7300020006003A000404C93FEAC6B359D649BC250902BBABB460000000004D0044003200000004020000040000000C00000001000300040600020C000000160100000200060032002A110000000014020000000000007B0000000000000000000000020000061700000001000000004E6F726D616C697A65000016000311E8000000C40100007B00000017000000010000001A0020110000000002000011000000000000000066697273740000001A002011010000000200001100000000000000006C617374000000001A002011020000000200001100000000000000006C656E67687400001A00201103000000020000110000000000000000666F756E640000001E00201104000000020000110000000000000000737562496E70757400000000020006004A000404C93FEAC6B359D649BC250902BBABB460000000004D0044003200000004020000040100000C00000001000006040600021C00000001650180A60180E9018108018155020616010000020006002E002A11000000007802000000000000150000000000000000000000040000069200000001000000002E6363746F72002E000404C93FEAC6B359D649BC250902BBABB460000000004D0044003200000004010000040100000C0000000100000602000600F20000003C0000000000000001000100170000000000000003000000300000000000000009000080010000000A000080150000000B000080050006000900370005000600F2000000B400000017000000010001007B000000000000000D000000A8000000000000000F000080010000001000008009000000EEEFFE800D000000100000800E0000001100008013000000130000801B000000140000802A0000001500008038000000160000803C0000001700008053000000180000806300000019000080780000001A00008030003100030028000000000029002A000400110003001800030040000300420003001D0003004A000300440003002B0002000300F200000024000000920000000100010015000000000000000100000018000000000000000C00008102005300F40000000800000001000000000000001800000000000000240000003C000000540000006C000000840000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF1A092FF1300000001C020000550000000100000025000000010000003D0000000100000085000000010000006D000000010000000100000001000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000C0000001800000024000000300000003C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022002511000000000400000001004E6F726D616C697A65517565727954657874000000001600291100000000040000000100303630303030303100001600251100000000E800000001004E6F726D616C697A65001600291100000000E800000001003036303030303032000016002511000000001802000001002E6363746F7200000000160029110000000018020000010030363030303030340000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000001010000FFFFFFFF1A092FF10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000942E3101BFBC54590100000066C902C5486C3A42BEF7A41729EBAF7D750000002F4C696E6B496E666F002F6E616D6573002F7372632F686561646572626C6F636B002F7372632F66696C65732F633A5C70726F6A656374735C6769745C7765626170706D6F6E69746F725C657874656E6465646576656E74737574696C735C6E6F726D616C697A657175657279746578742E6373000400000006000000010000003A0000000000000011000000070000000A000000060000000000000005000000220000000800000000000000DC513301000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF77093101010000000B00008E0C00055F0D00000060000000580000002C00000054000000000000000000000016000000190000000000EEC00000000000000000FFFFFFFF00000000FFFFFFFF00000000FFFF0000000000000000000000000A007C020000000000003C0100000100000000000000000000000000000055736572446566696E656446756E6374696F6E730037314141414545380000002DBA2EF10100000000000000170000000000000000000000000000000000000001000000170000007B0000000000000000000000000000000000000001000000920000001500000000000000000000000000000000000000020002000D01000000000100FFFFFFFF00000000A70000000802000000000000FFFFFFFF00000000FFFFFFFF010001000000010000000000433A5C50726F6A656374735C4769745C5765624170704D6F6E69746F725C457874656E6465644576656E74735574696C735C4E6F726D616C697A655175657279546578742E637300FEEFFEEF010000000100000000010000000000000000000000FFFFFFFFFFFFFFFFFFFF0900FFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E00000020000000D100000038000000A70100003800000000000000B6000000800000005C00000028000000D40300005C0200002C0000009C00000003000000120000000600000013000000070000000A0000000B00000008000000090000000C0000000D0000000E0000000F0000001100000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 AS N'ExtendedEventsUtils.pdb';

GO
CREATE FUNCTION [dbo].[NormalizeQueryText]
(@input NVARCHAR (MAX) NULL)
RETURNS NVARCHAR (MAX)
AS
 EXTERNAL NAME [ExtendedEventsUtils].[UserDefinedFunctions].[NormalizeQueryText]

GO	


DROP TABLE IF EXISTS dbo.Settings
GO

IF OBJECT_ID(N'dbo.Settings', 'U') IS NULL
	CREATE TABLE dbo.Settings (
		Id INT IDENTITY
	   ,Code VARCHAR(100) NULL
	   ,value NVARCHAR(MAX) NULL
	   ,PRIMARY KEY CLUSTERED (Id)
	) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

DROP TABLE IF EXISTS LockingMode;
CREATE TABLE LockingMode (
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID()
   ,Code NVARCHAR(MAX)
);
GO	

DROP TABLE IF EXISTS LongLocksInfo;
CREATE TABLE LongLocksInfo(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID()
	, BlockedQueryId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES NormQueryTextHistory(Id)
	, BlockerQueryId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES NormQueryTextHistory(Id)
	, LockingModeId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES LockingMode(Id)
	, Date DATETIME2
	, DateId INT FOREIGN KEY REFERENCES Dates (Id)
	, Duration BIGINT
);
GO	

