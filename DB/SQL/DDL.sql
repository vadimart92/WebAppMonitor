CREATE DATABASE tmp;
 GO
USE tmp
GO

CREATE TABLE Dates (Id INT PRIMARY KEY CLUSTERED IDENTITY, Date DATE)
GO
CREATE INDEX Ix_Date ON Dates (Date DESC)
CREATE TABLE dbo.QueryHistory (
	Id UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID() PRIMARY KEY CLUSTERED
   ,username NVARCHAR(MAX) NULL
   ,session_id NVARCHAR(MAX) NULL
   ,client_hostname NVARCHAR(MAX) NULL
   ,duration_sec  DECIMAL(18, 2)  NULL
   ,cpu_time_sec  DECIMAL(18, 2)  NULL
   ,logical_reads BIGINT NULL
   ,writes BIGINT NULL
   ,row_count BIGINT NULL
   ,end_time_utc DATETIME NULL
	, DateId INT FOREIGN KEY REFERENCES Dates (Id)
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
	
CREATE INDEX IDX_QueryHistory_DateId
ON QueryHistory (DateId)
ON [PRIMARY]

CREATE TABLE dbo.NormQueryTextHistory (
	Id UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID() PRIMARY KEY CLUSTERED
   ,NormalizedQuery VARCHAR(MAX)
   ,QueryHash VARBINARY(64)
)

CREATE INDEX IDX_NormQueryTextHistory_QueryHash
ON NormQueryTextHistory (QueryHash)
ON [PRIMARY]
GO
CREATE TABLE dbo.QueryTextHistory (
	QueryHistoryId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES QueryHistory
   ,NormQueryTextHistoryId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES NormQueryTextHistory
)
GO
CREATE TABLE dbo.TodayQuery (
	Id UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID() PRIMARY KEY CLUSTERED
   ,username NVARCHAR(MAX) NULL
   ,session_id NVARCHAR(MAX) NULL
   ,client_hostname NVARCHAR(MAX) NULL
   ,duration_sec  DECIMAL(18, 2)  NULL
   ,cpu_time_sec  DECIMAL(18, 2)  NULL
   ,logical_reads BIGINT NULL
   ,writes BIGINT NULL
   ,row_count BIGINT NULL
   ,end_time_utc DATETIME NULL
)
GO	
CREATE TABLE dbo.TodayNormQueryText (
	Id UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID() PRIMARY KEY CLUSTERED
   ,NormalizedQuery VARCHAR(MAX)
   ,QueryHash VARBINARY(64)
)
GO
CREATE TABLE dbo.TodayQueryText (
	TodayQueryId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES TodayQuery
	,QueryText VARCHAR(MAX)
	, TodayNormQueryTextId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES TodayQuery
)
GO
CREATE TABLE dbo.TempNormQueryText (
	TodayQueryId UNIQUEIDENTIFIER NULL
   ,NormalizedQuery VARCHAR(MAX) NULL
   ,NormalizedQueryHash VARBINARY(64) NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
CREATE TABLE dbo.ts_sqlprofiler (
	Id UNIQUEIDENTIFIER NULL
   ,db_name NVARCHAR(MAX) NULL
   ,username NVARCHAR(MAX) NULL
   ,session_id NVARCHAR(MAX) NULL
   ,client_hostname NVARCHAR(MAX) NULL
   ,duration_sec  DECIMAL(18, 2)  NULL
   ,cpu_time_sec  DECIMAL(18, 2)  NULL
   ,logical_reads BIGINT NULL
   ,writes BIGINT NULL
   ,row_count BIGINT NULL
   ,end_time_utc DATETIME NULL
   ,statement VARCHAR(MAX) NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

CREATE TABLE dbo.ts_sqlprofiler_data (
	XML XML NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

CREATE INDEX ixHash ON TempNormQueryText (NormalizedQueryHash);
IF OBJECT_ID('SaveDailyData', 'P') IS NULL BEGIN
	DECLARE @SQL NVARCHAR(MAX) ='CREATE PROCEDURE SaveDailyData AS BEGIN SET NOCOUNT ON END'
    EXEC sys.sp_executesql @SQL
END
GO
ALTER PROCEDURE SaveDailyData AS BEGIN

	WITH ImportDates AS (
		SELECT DISTINCT CAST(tq.end_time_utc AS DATE) ImportDate
		FROM TodayQuery tq
	)
	INSERT INTO Dates(Date)
		SELECT d.ImportDate
		FROM ImportDates d
			WHERE d.ImportDate NOT IN (SELECT Date FROM Dates)
	

	INSERT INTO QueryHistory (Id, username, session_id, client_hostname, duration_sec, cpu_time_sec, logical_reads, writes, row_count, end_time_utc, DateId)
	SELECT Id
		  ,username
		  ,session_id
		  ,client_hostname
		  ,duration_sec
		  ,cpu_time_sec
		  ,logical_reads
		  ,writes
		  ,row_count
		  ,end_time_utc
		 ,	(SELECT Id FROM Dates d WHERE d.Date = CAST(end_time_utc AS DATE))
	FROM TodayQuery;

	INSERT INTO NormQueryTextHistory (NormalizedQuery, QueryHash)
	SELECT tnqt.NormalizedQuery
		  ,tnqt.QueryHash
	FROM TodayNormQueryText tnqt
	WHERE tnqt.QueryHash NOT IN (SELECT QueryHash FROM NormQueryTextHistory)


	INSERT INTO QueryTextHistory (QueryHistoryId, NormQueryTextHistoryId)
	SELECT tqt.TodayQueryId
			,nqth.Id
	FROM TodayQueryText tqt
		INNER JOIN TodayNormQueryText tnqt ON tqt.TodayNormQueryTextId = tnqt.Id
		INNER JOIN NormQueryTextHistory nqth ON tnqt.QueryHash = nqth.QueryHash

END

EXEC sp_configure 'clr enabled' , '1'
go
reconfigure;
GO

DROP ASSEMBLY IF EXISTS [WebAppMonitor]
GO

CREATE ASSEMBLY [WebAppMonitor]
    AUTHORIZATION [dbo]
    FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300CA075C590000000000000000E00022200B013000000C00000006000000000000BA2A0000002000000040000000000010002000000002000004000000000000000600000000000000008000000002000000000000030060850000100000100000000010000010000000000000100000000000000000000000682A00004F00000000400000B802000000000000000000000000000000000000006000000C000000302900001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000C00A000000200000000C000000020000000000000000000000000000200000602E72737263000000B80200000040000000040000000E0000000000000000000000000000400000402E72656C6F6300000C00000000600000000200000012000000000000000000000000000040000042000000000000000000000000000000009C2A0000000000004800000002000500942200009C0600000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000133001001700000001000011000F00280600000A2803000006730700000A0A2B00062A2202280800000A002A1330040078000000020000110002280900000A130511052C06000213062B620272010000701A6F0A00000A17580A027201000070061A6F0B00000A0B0706590C061531110816310D026F0C00000A065908FE022B01160D092D03022B080206086F0D00000A13047E01000004110472050000706F0E00000A6F0F00000A13062B0011062A1B3003006001000003000011000214FE010B072C0800140C384D010000026F0F00000A0A0672090000701B6F1000000A0D09391B0100000006720D0000701B6F0A00000A13040672110000701B6F0A00000A1305110415310811051104FE022B0116130611062C170006110517586F1100000A6F0F00000A0A0038D20000000672150000701B6F1000000A1307110739BD0000000006731200000A130800151309720900007016281300000A130A720D00007016281300000A130B16130C16130D15130E066F0C00000A1759130F2B5A00110E1758130E1109110AFE01131011102C0A00110C1758130C002B141109110BFE01131111112C0800110D1758130D00110C110D3308110E110FFE042B0116131211122C130006110E17586F1100000A6F0F00000A0A2B170011086F1400000A25130915FE0116FE01131311132D9000DE0D11082C0811086F1500000A00DC00007E010000040672050000706F0E00000A6F0F00000A0C2B00082A0110000002009100A637010D0000000056721B000070200A020000731600000A80010000042A000042534A4201000100000000000C00000076342E302E33303331390000000005006C00000044020000237E0000B0020000B802000023537472696E677300000000680500005400000023555300BC050000100000002347554944000000CC050000D000000023426C6F620000000000000002000001571502000900000000FA013300160000010000001000000003000000010000000500000003000000160000000800000003000000010000000300000000003F0101000000000006008000D4010600A800D4010600C800D40106006C00C1011300F401000006006C0251010A0093008B010A00F80003020E00B2022B020600730119000600FB00510106005D01510106006E0151010600800119000600580051010E005F022B020000000010000000000001000100010010004A0200001900010001008101100018020C011900010003003100AF02860050200000000096009C028A0001007320000000008618A601010002007C2000000000960079029100020000210000000096008802910003007C22000000009118AC01960004000000010073020000010073020000010073020900A60101001100A60105001900A60101002100A6010A003900A60101004100E60015004100A60119003100A60101005900450028005900F0002D005900F0003400590029013C0059000201400049003D004600590058011500590034016400590002016B005100A6011900690001007000710038003C007900640001004900A601760020002B009A002E000B009A002E0013009F002E001B00A8002E002300C70060000B009A0063000B009A0080000B009A0010001E004C00048000000000000000000000000000000000B30100000400000000000000000000007D002F00000000000400000000000000000000007D002300000000000400000000000000000000007D00510100000000000000436F6E76657274546F5574663332003C4D6F64756C653E0053797374656D2E494F0053797374656D2E44617461006D73636F726C69620052656164005265706C6163650049734E756C6C4F72576869746553706163650049446973706F7361626C6500446973706F73650044656275676761626C6541747472696275746500457874656E73696F6E4174747269627574650053716C46756E6374696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465006765745F56616C756500496E6465784F660053716C537472696E6700537562737472696E67005765624170704D6F6E69746F722E4461746150726F63657373696E67006765745F4C656E6774680053746172747357697468005765624170704D6F6E69746F722E646C6C0053797374656D005472696D00537472696E67436F6D70617269736F6E004368617200537472696E675265616465720054657874526561646572004D6963726F736F66742E53716C5365727665722E536572766572002E63746F72002E6363746F72005765624170704D6F6E69746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053797374656D2E446174612E53716C54797065730053716C45787472616374696F6E5574696C730053797374656D2E546578742E526567756C617245787072657373696F6E730055736572446566696E656446756E6374696F6E730052656765784F7074696F6E73004F626A65637400696E70757400457874726163745270635465787400457874726163744C6F636B7353716C54657874004E6F726D616C697A6551756572795465787400456F6C5265676578000003270001032000000328000003290000030A0000052800400000355C0072005C0073002A007C005C006E005C0073002A007C005C0072005C006E0073002A007C005C006E005C0072005C0073002A000000000067EC785C9A25D940A2845741ABD33DAD0003200001042001010805200101111504070111210320000E042001010E090707080808020E020E040001020E062002080E1131072003080E081131032000080520020E08080520020E0E0E1707140E020E020808020212290808080808080802020202062002020E11310420010E08050002080E08062002010E114108B77A5C561934E08903061225060001112111210400010E0E0300000104010000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F77730108010007010000000000000000CA075C5900000000020000001C0100004C2900004C0B000052534453F1D480E6493406468BBF920E5FEF7A2801000000433A5C50726F6A656374735C4769745C5765624170704D6F6E69746F725C44425C5765624170704D6F6E69746F725C6F626A5C44656275675C5765624170704D6F6E69746F722E706462000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000902A00000000000000000000AA2A00000020000000000000000000000000000000000000000000009C2A0000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000005C02000000000000000000005C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004BC010000010053007400720069006E006700460069006C00650049006E0066006F0000009801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E003000000044001200010049006E007400650072006E0061006C004E0061006D00650000005700650062004100700070004D006F006E00690074006F0072002E0064006C006C0000002800020001004C006500670061006C0043006F0070007900720069006700680074000000200000004C00120001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000005700650062004100700070004D006F006E00690074006F0072002E0064006C006C000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E00300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000BC3A00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000;

GO
ALTER ASSEMBLY [WebAppMonitor]
    DROP FILE ALL
    ADD FILE FROM 0x4D6963726F736F667420432F432B2B204D534620372E30300D0A1A445300000000020000020000001F00000098000000000000001B000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C0FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF380000F0FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0BCA3101380000000010000000100000000000001000FFFF04000000FFFF03000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000BCA3101380000000010000000100000000000001100FFFF04000000FFFF0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000942E3101CA075C5901000000F1D480E6493406468BBF920E5FEF7A2800000000000000000100000001000000000000000000000000000000DC51330100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000BCA310138000000001000000010000000000000FFFFFFFF04000000FFFF030000000000FFFFFFFF00000000FFFFFFFF00000000FFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000BCA310138000000001000000010000000000000FFFFFFFF04000000FFFF030000000000FFFFFFFF00000000FFFFFFFF00000000FFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F862513FC607D311905300C04FA302A1C4454B99E9E6D211903F00C04FA302A10B9D865A1166D311BD2A0000F80849BDEC1618FF5EAA104D87F76F49638334601400000000000000AC588779C4368F14BEB5CA2B2B0959961EC1082C000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F862513FC607D311905300C04FA302A1C4454B99E9E6D211903F00C04FA302A10B9D865A1166D311BD2A0000F80849BDEC1618FF5EAA104D87F76F49638334601400000000000000A7CC40BDF903046DEB77B5CBBDDD12BD4BB6801B0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040200000000000004020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FEEFFEEF010000002E01000000433A5C50726F6A656374735C4769745C5765624170704D6F6E69746F725C5765624170704D6F6E69746F722E4461746150726F63657373696E675C53716C45787472616374696F6E5574696C732E63730000633A5C70726F6A656374735C6769745C7765626170706D6F6E69746F725C7765626170706D6F6E69746F722E6461746170726F63657373696E675C73716C65787472616374696F6E7574696C732E637300433A5C50726F6A656374735C4769745C5765624170704D6F6E69746F725C44425C5765624170704D6F6E69746F725C4E6F726D616C697A655175657279546578742E637300633A5C70726F6A656374735C6769745C7765626170706D6F6E69746F725C64625C7765626170706D6F6E69746F725C6E6F726D616C697A657175657279746578742E63730007000000E90000005200000053000000010000000000000000000000A4000000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001BE23001AC0000002FF9DF0F0CF5D2010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000004000000010000000A00000000000000E9000000280000001BE2300124364D315C000000A400000052000000E900000065000000000000000000000053000000280000001BE23001F14358175C00000001000000520000005300000065000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000003A002A1100000000D800000000000000170000000000000000000000010000060000000001000000004E6F726D616C697A65517565727954657874001600031104000000980000001700000000000000010000001A0024115553797374656D2E446174612E53716C547970657300000022002411555765624170704D6F6E69746F722E4461746150726F63657373696E67000000020006003A000404C93FEAC6B359D649BC250902BBABB460000000004D0044003200000004020000040000000C00000001000200040600020C0000001601000002000600F20000003C00000000000000010001001700000000000000030000003000000000000000080000800100000009000080150000000A000080050006000300360002000300F400000008000000A400000000000000080000000000000024000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000036002A11000000007801000000000000780000000000000000000000030000061700000001000000004578747261637452706354657874001600031104000000240100007800000017000000010000000A0024115553797374656D000E0024115553797374656D2E494F0000220024115553797374656D2E546578742E526567756C617245787072657373696F6E73001A0020110000000002000011000000000000000066697273740000001A002011010000000200001100000000000000006C617374000000001A002011020000000200001100000000000000006C656E67687400001A00201103000000020000110000000000000000666F756E640000001E00201104000000020000110000000000000000737562496E70757400000000020006004E000404C93FEAC6B359D649BC250902BBABB460000000004D004400320000000402000004000000100000000300000000000300040600021C00000001500180920180D60180F6018144020716010000020006003E002A11000000001404000000000000600100000000000000000000040000068F0000000100000000457874726163744C6F636B7353716C5465787400000000160003117C010000A0030000600100008F000000010000001A00201100000000030000110000000000000000726573756C74000016000311BC0100009C0300001B010000BA000000010000002600201104000000030000110000000000000000696E6465784F66436C6F73696E674272616365002200201105000000030000110000000000000000696E6465784F664E65774C696E65000016000311F001000098030000BB00000018010000010000001A002011080000000300001100000000000000007265616465720000160003115402000094030000A400000020010000010000001E002011090000000300001100000000000000006375727265627443686172001E0020110A0000000300001100000000000000007374617274427261636500001E0020110B000000030000110000000000000000656E64427261636500000000260020110C0000000300001100000000000000007374617274427261636573436F756E7400000000220020110D000000030000110000000000000000656E64427261636573436F756E7400001E0020110E000000030000110000000000000000706F73697374696F6E000000260020110F0000000300001100000000000000006D6178416C6C6F776564506F736974696F6E0000020006000200060002000600020006006E000404C93FEAC6B359D649BC250902BBABB460000000004D0044003200000004020000040100000C000000030000060406000040000000013F02071601025A0180A50180FD02814D0281DD01823101826101827E0182B30182E60183070183260183410283BB028408028454028370020006002E002A1100000000780400000000000015000000000000000000000005000006EF01000001000000002E6363746F72002E000404C93FEAC6B359D649BC250902BBABB460000000004D0044003200000004010000040100000C0000000300000602000600F2000000A8000000170000000100010078000000000000000C0000009C000000000000000C000080010000000D00008009000000EEEFFE800D0000000D0000800E0000000E00008013000000100000802200000011000080300000001200008034000000130000804B000000140000805B0000001500008075000000160000803A003B0004002900000000002A002B0005001200040041000400430004001E0004004B00040045000400320003000400F2000000AC0200008F00000001000100600100000000000037000000A00200000000000018000080010000001900008006000000EEEFFE8009000000190000800A0000001A000080110000001C000080180000001D00008025000000EEEFFE802B0000001D0000802C0000001E0000803A0000001F000080480000002000008058000000EEEFFE805C000000200000805D000000210000806D00000022000080730000002200008081000000EEEFFE8088000000220000808900000023000080910000002300008092000000240000809500000025000080A200000026000080AF00000027000080B200000028000080B500000029000080B80000002A000080C2000000EEEFFE80C40000002B000080C50000002C000080CB0000002D000080D3000000EEEFFE80D70000002D000080D80000002E000080DE0000002F000080E10000002F000080E9000000EEEFFE80ED0000002F000080EE00000030000080F400000031000080F50000003200008006010000EEEFFE800A010000320000800B010000330000801B010000340000801D010000360000801E0100002B00008030010000EEEFFE80340100003700008037010000EEEFFE8044010000380000804501000039000080460100003A0000805E0100003B0000803F0040000400160000000000170018000500110004002100040043000000000044004500050057000500530005004A00000000004B004C0006003B00050006000C004C00000000004D004E000D0032003400350007001C0007003400070032000700200007001E0007001A000700320000000000330034000800140008002600000000002700280009001C00080009000F002B00000000002C002D0009001A00080009000800510000000000520053000900390009000F00070008000700320000000000060007000000000005000600040005000400300003000400F200000024000000EF0100000100010015000000000000000100000018000000000000000900008103005400F4000000080000000100000000000000180000003C0000005C0000007400000098000000B0000000C8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF1A092FF140000000240200005D0000000100000025000000010000009900000001000000C9000000010000003D00000001000000B10000000100000075000000010000000100000001000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000C0000001800000024000000300000003C000000480000005400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022002511000000000400000001004E6F726D616C697A65517565727954657874000000001600291100000000040000000100303630303030303100001E0025110000000004000000020045787472616374527063546578740000000016002911000000000400000002003036303030303033000022002511000000007C0100000200457874726163744C6F636B7353716C5465787400000016002911000000007C01000002003036303030303034000016002511000000001804000002002E6363746F72000000001600291100000000180400000200303630303030303500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000E010000FFFFFFFF1A092FF100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006F726D616C697A655175657279546578742E637300433A5C50726F6A656374735C4769745C5765624170704D6F6E69746F725C5765624170704D6F6E69746F722E4461746150726F63657373696E675C53716C45787472616374696F6E5574696C732E6373000000FEEFFEEF010000000100000000010000000000000000000000FFFFFFFFFFFFFFFFFFFF0A00FFFFFFFFFFFFFFFFFFFF41414145453800000000000000FFFFFFFF00000000FFFFFFFF00000000FFFF0000000000000000000000000C007C04000000000000A0030000010000000000000000000000000000005765624170704D6F6E69746F722E4461746150726F63657373696E672E53716C45787472616374696F6E5574696C7300333337383634454100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF77093101010000000D00008E0E00055F0F000000DC000000740000002C000000AC000000000000000000000016000000190000000000EEC00000000000000000FFFFFFFF00000000FFFFFFFF00000000FFFF0000000000000000000000000B00DC00000000000000540000000100000000000000000000000000000055736572446566696E656446756E6374696F6E7300373141414145453800000000000000FFFFFFFF00000000FFFFFFFF00000000FFFF0000000000000000000000000C007C04000000000000A0030000010000000000000000000000000000005765624170704D6F6E69746F722E4461746150726F63657373696E672E53716C45787472616374696F6E5574696C73003333373836344541000000002DBA2EF10100000000000000170000000000000000000000000000000000000001000000170000007800000000000000010000000000000000000000010000008F000000600100000000000001000000000000000000000001000000EF0100001500000000000000010000000000000000000000020002000D01000000000100FFFFFFFF00000000040200000802000000000000FFFFFFFF00000000FFFFFFFF0200020000000100010001000000000045000000433A5C50726F6A656374735C4769745C5765624170704D6F6E69746F725C44425C5765624170704D6F6E69746F725C4E942E3101CA075C5901000000F1D480E6493406468BBF920E5FEF7A28CE0000002F4C696E6B496E666F002F6E616D6573002F7372632F686561646572626C6F636B002F7372632F66696C65732F633A5C70726F6A656374735C6769745C7765626170706D6F6E69746F725C7765626170706D6F6E69746F722E6461746170726F63657373696E675C73716C65787472616374696F6E7574696C732E6373002F7372632F66696C65732F633A5C70726F6A656374735C6769745C7765626170706D6F6E69746F725C64625C7765626170706D6F6E69746F725C6E6F726D616C697A657175657279746578742E637300050000000A0000000100000067000000000000002200000008000000110000000700000000000000050000007E000000090000000A0000000600000000000000DC5133010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000002000000032010000380000009702000038000000000000005E010000AC0000005C0000005C000000280000003C01000038080000740200002C000000E00000000300000019000000060000001800000017000000070000000B0000000C00000008000000090000000A0000000D0000000E0000000F000000100000001100000012000000130000001400000016000000150000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001A00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 AS N'WebAppMonitor.pdb';

GO
DROP FUNCTION IF EXISTS [dbo].[NormalizeQueryText];
GO
CREATE FUNCTION [dbo].[NormalizeQueryText]
(@input NVARCHAR (MAX) NULL)
RETURNS NVARCHAR (MAX)
AS
 EXTERNAL NAME [WebAppMonitor].[UserDefinedFunctions].[NormalizeQueryText]

GO	

IF OBJECT_ID(N'dbo.Settings', 'U') IS NULL
CREATE TABLE dbo.Settings (
	Id INT IDENTITY
	,Code VARCHAR(100) NULL
	,value NVARCHAR(MAX) NULL
	,PRIMARY KEY CLUSTERED (Id)
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

IF (OBJECT_ID('LockingMode', 'U') IS NULL)
CREATE TABLE LockingMode (
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID()
	,Code NVARCHAR(MAX)
);
GO	
IF (OBJECT_ID('QuerySource', 'U') IS NULL)
CREATE TABLE QuerySource (
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID()
   ,Code NVARCHAR(MAX)
);
GO	
IF (OBJECT_ID('NormQueryTextSource', 'U') IS NULL)
CREATE TABLE NormQueryTextSource (
	QuerySourceId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES QuerySource(Id)
	,NormQueryTextId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES NormQueryTextHistory(Id)
);
GO

IF (OBJECT_ID('LongLocksInfo', 'U') IS NULL)
CREATE TABLE LongLocksInfo(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID()
	, BlockedQueryId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES NormQueryTextHistory(Id)
	, BlockerQueryId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES NormQueryTextHistory(Id)
	, LockingModeId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES LockingMode(Id)
	, Date DATETIME2
	, DateId INT FOREIGN KEY REFERENCES Dates (Id)
	, Duration BIGINT
);
GO	
IF (OBJECT_ID('DeadLocksInfo', 'U') IS NULL)
CREATE TABLE DeadLocksInfo(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID()
	, QueryAId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES NormQueryTextHistory(Id)
	, QueryBId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES NormQueryTextHistory(Id)
	, Date DATETIME2
	, DateId INT FOREIGN KEY REFERENCES Dates (Id)
);
GO

IF (OBJECT_ID('StackSource', 'U') IS NULL)
CREATE TABLE StackSource (
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID()
	,Code NVARCHAR(MAX)
);
GO
IF (OBJECT_ID('Stack', 'U') IS NULL)
CREATE TABLE Stack (
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID()
	, SourceId UNIQUEIDENTIFIER FOREIGN KEY REFERENCES StackSource(Id)
	, StackTrace NVARCHAR(MAX)
	, StackHash VARBINARY(64) NULL
);
GO
IF (OBJECT_ID('ReaderLog', 'U') IS NULL)
CREATE TABLE ReaderLog (
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID()
	, [QueryId] UNIQUEIDENTIFIER FOREIGN KEY REFERENCES NormQueryTextHistory(Id)
	, [StackId] UNIQUEIDENTIFIER FOREIGN KEY REFERENCES Stack(Id)
	, [Date] DATETIME2
	, [DateId] INT FOREIGN KEY REFERENCES Dates (Id)
	, [Rows] BIGINT
);
GO

IF (OBJECT_ID('ImportedReaderLogRecord', 'U') IS NULL)
CREATE TABLE ImportedReaderLogRecord (
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID()
	,[Hash] VARBINARY(64)
);
GO
IF (OBJECT_ID('ImportedExecutorLogRecord', 'U') IS NULL)
CREATE TABLE ImportedExecutorLogRecord (
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID()
	,[Hash] VARBINARY(64)
);
GO
IF (OBJECT_ID('ImportedPerfomanceLogRecord', 'U') IS NULL)
CREATE TABLE ImportedPerfomanceLogRecord (
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID()
	,[Hash] VARBINARY(64)
);
GO

IF (OBJECT_ID('ExecutorLog', 'U') IS NULL)
CREATE TABLE ExecutorLog (
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID()
	, [QueryId] UNIQUEIDENTIFIER FOREIGN KEY REFERENCES NormQueryTextHistory(Id)
	, [StackId] UNIQUEIDENTIFIER FOREIGN KEY REFERENCES Stack(Id)
	, [Date] DATETIME2
	, [DateId] INT FOREIGN KEY REFERENCES Dates (Id)
	, [Duration] BIGINT
);
GO

CREATE INDEX IDX_QueryHistory_end_time_utc
ON QueryHistory (end_time_utc) 
ON [PRIMARY]  
GO

IF (OBJECT_ID('PerfomanceItemCode', 'U') IS NULL)
CREATE TABLE PerfomanceItemCode (
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID()
	, Code NVARCHAR(MAX)
);
GO
IF (OBJECT_ID('PerfomanceLogInfo', 'U') IS NULL)
CREATE TABLE PerfomanceLogInfo (
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID()
	, [Date] DATETIME2
	, [DateId] INT FOREIGN KEY REFERENCES Dates (Id)
	, [Duration] BIGINT
	, [ParentId] UNIQUEIDENTIFIER FOREIGN KEY REFERENCES PerfomanceLogInfo(Id)
	, [CodeId] UNIQUEIDENTIFIER FOREIGN KEY REFERENCES PerfomanceItemCode(Id)
);
GO